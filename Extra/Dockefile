# -------- Stage 1: Build --------
FROM ubuntu AS builder

RUN apt-get update && apt-get install -y openssl libssl-dev python3-pip && \

RUN apt-get install -y python3-venv python3-dev

RUN openssl req -x509 -newkey rsa:4096 -keyout key.pem -out cert.pem -days 365 -nodes -subj "/CN=localhost"

RUN apt-get clean && rm -rf /var/lib/apt/lists/*    

# # -------- Stage 2: Production --------
FROM python:3.10-slim

WORKDIR /app

# Copy only required files from builder
COPY --from=builder /key.pem /app/key.pem
COPY --from=builder /cert.pem /app/cert.pem
COPY app/ ./app

# Set environment so pip-installed packages are found
ENV PATH=/root/.local/bin:$PATH

EXPOSE 5000

CMD ["python", "app/main.py"]
